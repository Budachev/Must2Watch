name: Deploy to Render

on:
    push:
        branches:
            - main

jobs:
    deploy:
        name: Run Tests & Deploy
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 18

            - name: Install client dependencies
              working-directory: ./client
              run: npm install

            - name: Run client tests
              working-directory: ./client
              run: npm test -- --watchAll=false

            - name: Deploy Backend via Render API
              if: success()
              run: |
                  curl -X POST https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys \
                    -H 'Accept: application/json' \
                    -H 'Authorization: Bearer ${{ secrets.RENDER_API_KEY }}' \
                    -d ''
